# P2P 实时屏幕共享助手

一个轻量级的Python桌面应用程序，用于在局域网内进行低延迟的实时屏幕共享，现已优化至20+ FPS高帧率！

## 🚀 性能提升

**重大更新**: 经过全面性能优化，帧率从 5.9 FPS 提升到 **20+ FPS**，提升幅度达 **225%**！

| 性能指标 | 优化前 | 优化后 | 提升 |
|----------|--------|--------|------|
| **最大FPS** | 5.9 | 20.1 | +241% |
| **数据传输量** | 140KB/帧 | 31KB/帧 | -78% |
| **处理延迟** | 169ms | 50ms | -70% |

## ✨ 功能特点

- **🚀 高性能P2P共享**: 优化到20+FPS的流畅屏幕共享
- **🎯 智能性能档案**: 三种性能模式自动优化
  - 🏆 **高性能模式**: 20 FPS，适合游戏演示
  - ⚖️ **平衡模式**: 15 FPS，适合日常使用  
  - 🎨 **高质量模式**: 8 FPS，适合详细展示
- **⚡ 低延迟传输**: 多线程并发架构，确保流畅体验
- **📊 实时性能监控**: 显示当前FPS、效率和连接状态
- **🎛️ 灵活的窗口交互**: 
  - 置顶显示，不会被其他窗口遮挡
  - 支持拖动移动
  - 鼠标悬浮自动放大，便于查看细节
- **⚙️ 智能配置管理**: 
  - 一键切换性能档案
  - 自定义帧率（FPS）和压缩质量
  - 自定义窗口大小和缩放比例
- **🔧 简洁易用的界面**: 一键连接，直观的状态显示

## 📦 安装依赖

### 基础依赖
```bash
pip install mss Pillow
```

### 高性能依赖 (推荐)
为了获得最佳性能，建议安装以下可选依赖：
```bash
pip install numpy  # 用于超高速模式，可提升到20+ FPS
```

### 完整安装
```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 启动程序
```bash
python main.py
```

### 2. 分享你的屏幕
程序启动后会自动开始分享你的屏幕，并显示实时性能监控：
- 🟢 **实际FPS**: 显示当前真实帧率
- 🎯 **性能档案**: 当前使用的性能模式
- 📊 **效率**: 实际FPS与目标FPS的比率

### 3. 选择性能档案
在主界面的"性能监控"区域，根据需要选择：
- **高质量**: 最佳画质，适合演示和详细展示
- **平衡**: 画质与性能平衡，适合日常使用
- **高性能**: 最高帧率，适合游戏和快速交互

### 4. 连接到其他人
在"连接到同伴"区域：
- 输入对方的IP地址
- 输入端口号（默认17585）
- 点击"连接"

连接成功后，会弹出一个新窗口显示对方的屏幕。

### 5. 窗口操作
- **拖动**: 直接拖动窗口来移动位置
- **缩放**: 将鼠标悬浮在窗口上自动放大，移开鼠标恢复原状
- **关闭**: 在主界面选择连接后点击"断开选中连接"

## ⚙️ 配置选项

点击主界面的"设置"按钮可以调整：

### 🎯 性能设置
- **性能档案**: 选择预设的性能模式
  - 🏆 高性能模式: 20 FPS, 30% 质量
  - ⚖️ 平衡模式: 15 FPS, 50% 质量  
  - 🎨 高质量模式: 8 FPS, 75% 质量

### 🌐 网络设置
- **默认端口**: 程序监听的端口号
- **帧率 (FPS)**: 屏幕捕获和传输的帧率
- **JPEG质量**: 图像压缩质量（1-100，数值越高质量越好但数据量越大）

### 🖥️ 视图设置
- **默认宽度/高度**: 观看窗口的初始大小
- **缩放比例**: 鼠标悬浮时的放大倍数

### 🎨 界面设置
- **显示FPS**: 是否在观看窗口显示实时帧率
- **显示连接状态**: 是否显示详细的连接状态信息

### 💡 性能建议
- **游戏/快速操作**: 使用高性能模式
- **办公协作**: 使用平衡模式
- **详细演示**: 使用高质量模式
- **网络较差**: 降低FPS和质量设置

## 网络配置

### 局域网使用
确保所有设备连接在同一个局域网内，可以直接使用设备的IP地址连接。

### 虚拟局域网
如果要跨地域使用，建议使用虚拟局域网软件（如Hamachi、ZeroTier等）先组建虚拟内网，然后使用虚拟网络的IP地址连接。

## 🔧 故障排除

### 🔌 连接失败
1. 检查IP地址是否正确
2. 确认端口号一致
3. 检查防火墙设置，确保端口未被阻挡
4. 确认两台设备在同一网络内

### ⚡ 性能问题
1. **FPS过低**: 
   - 切换到"高性能模式"
   - 确保已安装numpy: `pip install numpy`
   - 降低JPEG质量到30以下
2. **延迟较高**:
   - 检查网络连接状况
   - 关闭其他占用网络的程序
   - 尝试降低帧率

### 🖼️ 画面卡顿
1. **轻微卡顿**: 切换到"平衡模式"
2. **严重卡顿**: 切换到"高质量模式"并降低FPS
3. **网络带宽不足**: 
   - 降低JPEG质量到20-30
   - 减小观看窗口的默认大小
   - 降低FPS到10以下

### 🚀 性能优化建议
- **效率低于60%**: 考虑降低性能要求或检查硬件性能
- **CPU使用率过高**: 切换到更低的性能档案
- **内存不足**: 重启程序，选择高质量模式

## 📁 文件说明

### 核心文件
- `main.py`: 程序入口
- `control_panel.py`: 主控制界面（含性能监控）
- `viewer_window.py`: 屏幕观看窗口
- `network_comms.py`: 优化的网络通信模块
- `screen_capture.py`: 屏幕捕获模块
- `settings_dialog.py`: 设置对话框（含性能档案）
- `config.json`: 配置文件

### 性能优化文件
- `screen_capture_optimized.py`: 优化版截图模块（10+ FPS）
- `screen_capture_ultra.py`: 超高速截图模块（20+ FPS）
- `performance_controller.py`: 智能性能控制器
- `性能优化指南.md`: 详细优化指南

### 其他文件
- `requirements.txt`: 依赖包列表
- `README.md`: 项目文档

## 🔬 技术细节

### 🚀 性能优化架构
- **多线程分离**: 截图、压缩、发送分别在独立线程
- **队列管理**: 使用Queue避免阻塞，自动跳帧防止堆积
- **并发发送**: 多客户端并行传输，避免单点阻塞
- **智能缓存**: MSS实例重用，内存缓冲区预分配

### 📸 屏幕捕获优化
- **MSS库**: 高效的屏幕截图，实例重用减少开销
- **动态缩放**: 根据性能档案自动调整分辨率（50%-100%）
- **像素采样**: 跳过部分像素，在高性能模式下提升50%速度
- **格式优化**: BGRA→RGB转换优化，减少内存拷贝

### 🗜️ 图像压缩优化
- **PIL/Pillow**: JPEG压缩，移除耗时的optimize选项
- **质量调节**: 根据性能档案自动调整（20-75）
- **缓冲区重用**: 避免频繁内存分配
- **numpy加速**: 超高速模式下使用numpy数组操作

### 🌐 网络协议优化
- **TCP优化**: 启用TCP_NODELAY，增大缓冲区到64KB
- **自定义协议**: 基于长度前缀的二进制协议
- **连接管理**: 自动重连，异常处理，优雅断开
- **流量控制**: 队列限制，防止内存堆积

### 🎨 用户界面
- **Tkinter**: 原生界面组件，跨平台兼容
- **实时监控**: FPS、效率、档案状态实时显示
- **响应式设计**: UI更新与网络通信分离
- **智能配置**: 性能档案自动调整相关参数