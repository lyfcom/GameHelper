# 项目：P2P实时屏幕共享助手 (Project: Peer-to-Peer Real-time Screen Sharing)

## 项目概述

本项目旨在创建一个轻量级的Python桌面应用程序，用于实现对等（P2P）的实时屏幕共享。在此模型下，每个用户既是屏幕内容的“分享端”，也都可以是“观看端”，可以同时观看一个或多个其他参与者的屏幕。应用主要面向局域网（包括虚拟内网）环境，为每个被观看的同伴（Peer）创建一个独立的、置顶的、可交互的窗口。这些窗口设计精巧，支持拖动、鼠标悬浮放大等功能，旨在以最低的干扰提供流畅、清晰的屏幕共享体验。

---

## 任务清单 (TODO List)

### 第一阶段：核心P2P架构与原型 (Phase 1: Core P2P Architecture & Prototyping)

-   [ ] **1. 项目结构搭建**
    -   [ ] 创建主应用文件 (`main.py`)。
    -   [ ] 创建核心模块:
        -   `screen_capture.py`: 负责捕获本机屏幕。
        -   `network_comms.py`: 统一管理所有网络通信（作为服务端被动监听，以及作为客户端主动连接）。
        -   `viewer_window.py`: 实现用于显示单个同伴屏幕的窗口类。
        -   `control_panel.py`: 实现主控制面板的UI和逻辑。
    -   [ ] 初始化 `requirements.txt` 文件 (罗列 `mss`, `Pillow` 等核心依赖)。

-   [ ] **2. 屏幕捕获与压缩模块 (`screen_capture.py`)**
    -   [ ] 实现一个高效的函数，使用 `mss` 库捕获全屏。
    -   [ ] 实现一个函数，将捕获的图像用 `Pillow` 库在内存中压缩为JPEG格式，并允许调整压缩质量以平衡清晰度与数据量。

-   [ ] **3. 对等网络通信模块 (`network_comms.py`)**
    -   [ ] **服务端部分 (分享本机屏幕):**
        -   [ ] 实现一个 `Server` 类，在独立的后台线程中运行。
        -   [ ] 该服务绑定到固定端口，监听并接受来自其他同伴的连接请求。
        -   [ ] 为所有已连接的同伴，持续地广播（多播）本机压缩后的屏幕图像数据。
        -   [ ] 设计数据帧协议：例如，每个数据包以一个固定长度（如8字节）的头部开始，标明后续图像数据的长度，然后紧跟图像数据。
    -   [ ] **客户端部分 (观看同伴屏幕):**
        -   [ ] 实现一个 `Client` 类，用于处理单个到外部同伴的连接。
        -   [ ] 每个 `Client` 实例也应在独立的后台线程中运行，以避免阻塞UI。
        -   [ ] 它负责连接到指定同伴的IP和端口，并持续接收数据。
        -   [ ] 它将接收到的数据流解析成一帧帧完整的图像，并通过线程安全的队列（`queue.Queue`）传递给对应的UI窗口。

### 第二阶段：UI/UX - 主控面板与视图窗口 (Phase 2: UI/UX - Control Panel & Viewer Windows)

-   [ ] **1. 视图窗口实现 (`viewer_window.py`)**
    -   [ ] 创建一个 `ViewerWindow` 类 (可继承自 `tkinter.Toplevel`)。
    -   [ ] **窗口核心特性:**
        -   [ ] 设置为无边框窗口 (`overrideredirect(True)`)。
        -   [ ] 设置为总在最前/置顶 (`attributes('-topmost', True)`)。
    -   [ ] **交互功能:**
        -   [ ] **窗口拖动:** 绑定鼠标事件 (`<ButtonPress-1>`, `<B1-Motion>`)，实现无边框窗口的自由拖拽。
        -   [ ] **悬浮缩放:** 绑定鼠标进入/离开事件 (`<Enter>`, `<Leave>`)，在鼠标悬浮时将窗口和图像平滑放大（如200%），鼠标离开时恢复。使用 `Pillow` 的抗锯齿缩放。
    -   [ ] **数据展示:**
        -   [ ] 在窗口内放置一个 `Label` 组件用于显示图像。
        -   [ ] 实现一个 `update_image` 方法，该方法从客户端线程的队列中获取新图像，并更新到 `Label` 上。

-   [ ] **2. 主控面板实现 (`control_panel.py`)**
    -   [ ] 创建主程序窗口，作为用户交互的中心。
    -   [ ] **面板UI元素:**
        -   [ ] 显示本机的IP地址和监听端口，方便他人连接。
        -   [ ] 提供输入框和“连接”按钮，用于添加新的同伴IP。
        -   [ ] 使用一个列表框（`Listbox`）来显示所有当前连接的同伴。
        -   [ ] 提供“断开连接”按钮，用于断开选中的同伴。
    -   [ ] **连接管理逻辑:**
        -   点击“连接”后，主程序将实例化一个 `network_comms.Client` 并启动其线程，同时创建一个与之关联的 `ViewerWindow` 实例。
        -   维护一个数据结构（如字典），将同伴IP与对应的 `Client` 和 `ViewerWindow` 实例关联起来，方便管理。

### 第三阶段：健壮性、配置与分发 (Phase 3: Robustness, Configuration & Distribution)

-   [ ] **1. 错误处理与生命周期管理**
    -   [ ] 确保关闭主控面板时，能优雅地终止所有网络线程（服务和客户端）并关闭所有视图窗口。
    -   [ ] 健壮地处理连接失败、同伴主动断开等网络异常。当连接丢失时，对应的视图窗口应自动关闭或显示“已断开”状态，并在主控面板的列表中移除。
    -   [ ] 对用户输入的无效IP地址等情况提供清晰的错误提示。
    -   [ ] 服务端需要能处理单个客户端的意外掉线，而不影响对其他客户端的服务。

-   [ ] **2. 性能优化与可配置性**
    -   [ ] 严格分离UI线程和工作线程（网络、图像处理），保证界面的流畅响应。
    -   [ ] (可选) 创建一个 `config.json` 或在UI中提供设置选项，允许用户配置：
        -   屏幕捕获的帧率（FPS）。
        -   JPEG压缩质量。
        -   视图窗口的默认大小和缩放比例。
        -   网络监听端口。

-   [ ] **3. 打包与文档**
    -   [ ] 编写详细的 `README.md`，包括功能介绍、使用方法（特别是如何进行P2P连接）和运行说明。
    -   [ ] 使用 `PyInstaller` 或类似工具将整个项目打包成单个可执行文件（`.exe`），方便没有Python环境的用户使用。
    -   [ ] 在纯净的系统环境中测试打包后的可执行文件，确保所有依赖都已正确包含。
