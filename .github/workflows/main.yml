name: Build and Release

on:
  push:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install nuitka
        pip install -r requirements.txt

    - name: Compile with Nuitka
      # 使用 Nuitka 编译为独立可执行文件，具有更好的性能和启动速度
      # Use Nuitka to compile to standalone executable with better performance and startup speed
      run: |
        nuitka --standalone `
        --assume-yes-for-downloads `
        --windows-disable-console `
        --enable-plugin=tk-inter `
        --enable-plugin=numpy `
        --nofollow-import-to=pytest `
        --nofollow-import-to=unittest `
        --include-package=mss `
        --include-package=PIL `
        --include-module=control_panel `
        --include-module=network_comms `
        --include-module=screen_capture `
        --include-module=screen_capture_optimized `
        --include-module=screen_capture_ultra `
        --include-module=settings_dialog `
        --include-module=viewer_window `
        --output-filename="main.exe" `
        --output-dir=dist `
        main.py

    # 简化Nuitka输出结构调整，仅保留核心逻辑
    - name: Prepare Nuitka Output for Inno Setup
      run: |
        # 查找Nuitka输出目录 (*.dist)
        $nuitkaDir = Get-ChildItem -Path "dist" -Directory | Where-Object { $_.Name -like "*.dist" } | Select-Object -First 1
        if (-not $nuitkaDir) {
            Write-Host "❌ 未找到Nuitka输出目录 (*.dist)"
            exit 1
        }
        # 创建目标目录
        New-Item -ItemType Directory -Force -Path "dist/main" | Out-Null
        # 移动所有内容到dist/main
        Move-Item -Path "$($nuitkaDir.FullName)\*" -Destination "dist/main/"
        # 检查main.exe
        if (-not (Test-Path "dist/main/main.exe")) {
            Write-Host "❌ main.exe 不存在"
            exit 1
        }
        # 清理
        Remove-Item -Path $nuitkaDir.FullName -Recurse -Force -ErrorAction SilentlyContinue
        Write-Host "✅ Nuitka输出已准备好"

    - name: Install Inno Setup
      run: choco install innosetup --no-progress --yes

    - name: Compile Installer with Inno Setup
      run: |
        iscc inno_setup.iss
      shell: cmd

    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: P2P-Screen-Sharing-Installer
        path: Output/P2P-Screen-Sharing-Setup.exe

